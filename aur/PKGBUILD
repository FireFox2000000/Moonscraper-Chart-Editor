# Maintainer: bmwalters <oss at walters dot app>

pkgname=moonscraper-chart-editor
pkgver=1.6.0.u6000.0.62f1
pkgrel=1
pkgdesc="A song editor for Guitar Hero style rhythm games made in Unity"
url='https://github.com/FireFox2000000/moonscraper-chart-editor'
license=(BSD)
arch=(x86_64)
depends=('mono' 'sdl2' 'ffmpeg' 'libx11' 'gtk3' 'libbass' 'libbass_fx' 'libbassopus')
makedepends=('git' 'unityhub' 'cmake'
  # runtime dependencies for Unity3d
  'desktop-file-utils' 'xdg-utils' 'gcc-libs' 'gconf' 'nss'
  'libgl' 'glu' 'libpng12' 'libxtst' 'libpqxx' 'npm' 'intel-tbb'
  # used to isolate home directory files modified by Unity3d
  'firejail')
provides=(moonscraper-chart-editor)
backup=("opt/$pkgname/local_events.txt"
        "opt/$pkgname/global_events.txt"
        "opt/$pkgname/Custom Resources/settings.ini")
source=('git+https://github.com/FireFox2000000/moonscraper-chart-editor.git#branch=master'
        "$pkgname.desktop")
sha256sums=('SKIP'
            'cc10aebee30527ee5974122e85dd9bc69a8ab687d420eca663c032f8aabdeb35')
_unity3d_version=6000.0.62f1
_unity3d_changeset=f99f05b3e950

pkgver() {
  cd "$pkgname"

  printf "%s" "$(git describe --long --tags --always | sed 's/\([^-]*-g\)/r\1/;s/-/./g')"
}

prepare() {
  # Remove vendored libbass in favor of libbass dependency
  rm -rf "$pkgname/Moonscraper Chart Editor/Assets/Plugins/Bass Audio/Linux/x64"
  rm -f "$pkgname/Moonscraper Chart Editor/Assets/Plugins/Bass Audio/Linux/x64.meta"
}

build() {
  # Install Unity via unityhub in firejail to avoid clobbering user's existing unityhub configuration.
  firejail --noprofile --whitelist="$(pwd)" sh <<EOF
  # Install appropriate unity3d version via unityhub
  if [ ! -d "$(pwd)"/unity3d/$_unity3d_version ]; then
    mkdir -p unity3d
    unityhub --no-sandbox --headless install-path --set "$(pwd)"/unity3d
    unityhub --no-sandbox --headless install --version $_unity3d_version --changeset $_unity3d_changeset
  fi

  # https://github.com/mono/mono/issues/6752#issuecomment-365212655
  export TERM=xterm

  export SEVENZIP=$(which 7z)

  # Build the application using Unity in batch mode
  "$(pwd)/unity3d/$_unity3d_version/Editor/Unity" \
    -batchmode \
    -nographics \
    -silent-crashes \
    -logFile - \
    -projectPath "$pkgname/Moonscraper Chart Editor" \
    -executeMethod BuildManager.BuildLinux \
    -moonscraperBuildPath "$(pwd)/build" \
    -quit
EOF
}

package() {
  install -o $(whoami) -d "$pkgdir/opt/$pkgname"

  VERSION=$(grep -oP 'bundleVersion: \K(.+)' < "$srcdir/$pkgname/Moonscraper Chart Editor/ProjectSettings/ProjectSettings.asset")
  cp -aR "$(pwd)/build/Moonscraper Chart Editor v$VERSION Linux (64 bit)/." "$pkgdir/opt/$pkgname"
  install -o $(whoami) -Dm 644 "$pkgname/LICENSE" "$pkgdir/opt/$pkgname/LICENSE"

  RUNVIA="$pkgdir/opt/$pkgname/Moonscraper Chart Editor"

  echo ""
  read -p "Do you want to install Moonscraper Chart Editor to /opt/$pkgname? [Yn] " optinstall
  if [ "${optinstall#[Yy]}" == "" ]; then
    echo -e "\nYou may be prompted for your password.\n"
    sudo install -o $(whoami) -d "/opt/$pkgname"
    sudo cp -aR "$pkgdir/opt/$pkgname" "/opt"

    RUNVIA="/opt/$pkgname/Moonscraper Chart Editor"

    echo ""
    read -p "Do you want to install Moonscraper Chart Editor link to /usr/local/bin allowing you to to launch Moonscraper Chart Editor from terminal? [yN] " bininstall
    if [ "${bininstall#[Nn]}" != "" ]; then
      sudo install -o $(whoami) -d /usr/local/bin
      sudo bash -c "tee \"/usr/local/bin/$pkgname\" &>/dev/null <<EOF
#!/bin/sh
exec \"/opt/$pkgname/Moonscraper Chart Editor\" \"\$@\"
EOF"
      sudo chmod 755 "/usr/local/bin/$pkgname"

      RUNVIA="$pkgname"
    fi

    echo ""
    read -p "Do you want to add Moonscraper Chart Editor to your desktop? [yN] " desktopinstall
    if [ "${desktopinstall#[Nn]}" != "" ]; then
      sudo install -o $(whoami) -d /usr/local/bin
      sudo bash -c "tee \"/usr/local/bin/$pkgname\" &>/dev/null <<EOF
#!/bin/sh
exec \"/opt/$pkgname/Moonscraper Chart Editor\" \"\$@\"
EOF"
      sudo chmod 755 "/usr/local/bin/$pkgname"

      sudo install -o $(whoami) -d /usr/local/share/applications /usr/local/share/pixmaps
      sudo install $pkgname.desktop "/usr/local/share/applications"
      sudo ln -fs "/opt/$pkgname/Moonscraper Chart Editor_Data/Resources/UnityPlayer.png" "/usr/local/share/pixmaps/$pkgname.png"
    fi

    # Clean up
    rm -Rf "$(pwd)/build/Moonscraper Chart Editor v$VERSION Linux (64 bit).tar"
    rm -Rf "$pkgdir/opt"
  fi

  echo -e "\nMoonscraper Chart Editor v$VERSION installed, run '$RUNVIA' to begin\n"
}
